{% extends "base.html" %}

{% block title %}Checkout - BuddyShop{% endblock %}

{% block content %}
<div class="container">
    <h1>Checkout</h1>
    
    <div class="checkout-container">
        <div class="checkout-form">
            <h2>Delivery Address</h2>
            
            <div class="form-group">
                <label>Search Address</label>
                <input type="text" id="addressSearch" placeholder="Search for your address...">
            </div>
            
            <div id="map" class="map-container"></div>
            
            <div class="form-group">
                <label>Full Address</label>
                <textarea id="fullAddress" rows="3" placeholder="Enter your full delivery address"></textarea>
            </div>
            
            <input type="hidden" id="latitude">
            <input type="hidden" id="longitude">
            
            <button class="btn-primary btn-large btn-block" onclick="placeOrder()">
                <i class="fas fa-check"></i> Place Order
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let map;
let marker;
let selectedLat = null;
let selectedLng = null;

function initMap() {
    map = L.map('map').setView([28.6139, 77.2090], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    map.on('click', function(e) {
        if (marker) {
            map.removeLayer(marker);
        }
        
        marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
        selectedLat = e.latlng.lat;
        selectedLng = e.latlng.lng;
        
        document.getElementById('latitude').value = selectedLat;
        document.getElementById('longitude').value = selectedLng;
        
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${selectedLat}&lon=${selectedLng}`)
            .then(response => response.json())
            .then(data => {
                if (data.display_name) {
                    document.getElementById('fullAddress').value = data.display_name;
                }
            });
    });
}

document.getElementById('addressSearch').addEventListener('input', async (e) => {
    const query = e.target.value;
    if (query.length < 3) return;
    
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const results = await response.json();
        
        if (results.length > 0) {
            const result = results[0];
            map.setView([result.lat, result.lon], 15);
            
            if (marker) {
                map.removeLayer(marker);
            }
            
            marker = L.marker([result.lat, result.lon]).addTo(map);
            selectedLat = result.lat;
            selectedLng = result.lon;
            
            document.getElementById('latitude').value = selectedLat;
            document.getElementById('longitude').value = selectedLng;
            document.getElementById('fullAddress').value = result.display_name;
        }
    } catch (error) {
        console.error('Address search failed:', error);
    }
});

async function placeOrder() {
    const address = document.getElementById('fullAddress').value;
    const latitude = document.getElementById('latitude').value;
    const longitude = document.getElementById('longitude').value;
    
    if (!address) {
        showNotification('Please enter delivery address', 'error');
        return;
    }
    
    try {
        const response = await fetch('/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                address: address,
                latitude: latitude,
                longitude: longitude
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                window.location.href = '/orders';
            }, 1500);
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        showNotification('Failed to place order', 'error');
    }
}

initMap();
</script>
{% endblock %}
