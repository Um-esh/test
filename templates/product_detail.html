{% extends "base.html" %}

{% block title %}{{ product.name }} - BuddyShop{% endblock %}

{% block content %}
<div class="container">
    <div class="product-detail">
        <div class="product-gallery">
            <div class="main-image">
                {% if product.images and product.images|length > 0 %}
                    <img id="mainImage" src="{{ product.images[0] }}" alt="{{ product.name }}">
                {% else %}
                    <img id="mainImage" src="https://via.placeholder.com/500x500?text=No+Image" alt="{{ product.name }}">
                {% endif %}
            </div>
            
            {% if product.images and product.images|length > 1 %}
            <div class="thumbnail-images">
                {% for image in product.images %}
                <img src="{{ image }}" alt="{{ product.name }}" onclick="changeImage('{{ image }}')" class="thumbnail">
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <div class="product-details">
            <h1>{{ product.name }}</h1>
            
            <div class="product-category-tag">
                <i class="fas fa-tag"></i> {{ product.category }}
            </div>
            
            <div class="product-price-big">â‚¹{{ product.price }}</div>
            
            <div class="product-stock">
                {% if product.stock > 0 %}
                    <span class="in-stock"><i class="fas fa-check-circle"></i> In Stock ({{ product.stock }} available)</span>
                {% else %}
                    <span class="out-of-stock"><i class="fas fa-times-circle"></i> Out of Stock</span>
                {% endif %}
            </div>
            
            <div class="product-description-full">
                <h3>Description</h3>
                <p>{{ product.description }}</p>
            </div>
            
            <div class="product-actions">
                <div class="quantity-selector">
                    <label>Quantity:</label>
                    <input type="number" id="quantity" value="1" min="1" max="{{ product.stock }}">
                </div>
                
                {% if user %}
                <div id="productActions">
                    {% if product.stock > 0 %}
                    <button class="btn-primary btn-large" id="buyNowBtn" onclick="showPurchaseOptions()" style="display:none;">
                        <i class="fas fa-shopping-bag"></i> Buy Now
                    </button>
                    <div id="cartManagement" style="display:none;">
                        <button class="btn-secondary btn-large" onclick="updateCartQuantity()">
                            <i class="fas fa-sync"></i> Update Quantity
                        </button>
                        <button class="btn-danger btn-large" onclick="removeFromCartProduct()">
                            <i class="fas fa-trash"></i> Remove from Cart
                        </button>
                    </div>
                    {% else %}
                    <button class="btn-primary btn-large" disabled>
                        Out of Stock
                    </button>
                    {% endif %}
                </div>
                {% else %}
                <button class="btn-primary btn-large" onclick="window.location.href='/login'">
                    Login to Buy
                </button>
                {% endif %}
            </div>
            
            <div id="purchaseModal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="close" onclick="closePurchaseModal()">&times;</span>
                    <h2>Choose Purchase Option</h2>
                    <div class="purchase-options">
                        <button class="option-btn" onclick="addToCart()">
                            <i class="fas fa-shopping-cart"></i>
                            <h3>Add to Cart</h3>
                            <p>Continue shopping and checkout later</p>
                        </button>
                        <button class="option-btn" onclick="selectForPickup()">
                            <i class="fas fa-store"></i>
                            <h3>Self Pickup</h3>
                            <p>Pick up from shop location</p>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function changeImage(src) {
    document.getElementById('mainImage').src = src;
    
    document.querySelectorAll('.thumbnail').forEach(thumb => {
        thumb.classList.remove('active');
    });
    event.target.classList.add('active');
}

async function checkCartStatus() {
    try {
        const response = await fetch('/cart/check/{{ product.product_id }}');
        const data = await response.json();
        
        if (data.in_cart) {
            document.getElementById('buyNowBtn').style.display = 'none';
            document.getElementById('cartManagement').style.display = 'block';
            document.getElementById('quantity').value = data.quantity;
        } else {
            document.getElementById('buyNowBtn').style.display = 'block';
            document.getElementById('cartManagement').style.display = 'none';
        }
    } catch (error) {
        console.error('Error checking cart:', error);
    }
}

{% if user %}
window.addEventListener('DOMContentLoaded', checkCartStatus);
{% endif %}

function showPurchaseOptions() {
    document.getElementById('purchaseModal').style.display = 'flex';
}

function closePurchaseModal() {
    document.getElementById('purchaseModal').style.display = 'none';
}

async function addToCart() {
    const quantity = parseInt(document.getElementById('quantity').value);
    
    try {
        const response = await fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                product_id: '{{ product.product_id }}',
                quantity: quantity
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            closePurchaseModal();
            checkCartStatus();
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        showNotification('Failed to add to cart', 'error');
    }
}

async function selectForPickup() {
    const quantity = parseInt(document.getElementById('quantity').value);
    
    try {
        const response = await fetch('/pickup/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                product_id: '{{ product.product_id }}',
                quantity: quantity
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            closePurchaseModal();
            window.location.href = '/pickup-items';
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        showNotification('Failed to add for pickup', 'error');
    }
}

async function updateCartQuantity() {
    const quantity = parseInt(document.getElementById('quantity').value);
    
    try {
        const response = await fetch('/cart/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                product_id: '{{ product.product_id }}',
                quantity: quantity
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            checkCartStatus();
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        showNotification('Failed to update quantity', 'error');
    }
}

async function removeFromCartProduct() {
    if (!confirm('Remove this item from cart?')) return;
    
    try {
        const response = await fetch('/cart/remove-by-product/{{ product.product_id }}', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            checkCartStatus();
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        showNotification('Failed to remove from cart', 'error');
    }
}
</script>
<style>
.modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 10px;
    max-width: 500px;
    width: 90%;
    position: relative;
}

.close {
    position: absolute;
    right: 20px;
    top: 15px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #888;
}

.close:hover {
    color: #000;
}

.purchase-options {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

.option-btn {
    flex: 1;
    padding: 20px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
}

.option-btn:hover {
    border-color: #2874f0;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.option-btn i {
    font-size: 40px;
    color: #2874f0;
    margin-bottom: 10px;
}

.option-btn h3 {
    margin: 10px 0;
    color: #333;
}

.option-btn p {
    font-size: 14px;
    color: #666;
}

.btn-secondary {
    background: #6c757d !important;
}

.btn-secondary:hover {
    background: #5a6268 !important;
}

.btn-danger {
    background: #dc3545 !important;
}

.btn-danger:hover {
    background: #c82333 !important;
}

#cartManagement {
    display: flex;
    gap: 10px;
}
</style>
{% endblock %}
